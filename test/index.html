<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="connect-src 'self' ws://localhost:8080;">
    <title>WebSocket Client</title>
</head>
<body>

<div>
    <label for="message">Message:</label>
    <input type="text" id="message" placeholder="Enter your message">
    <button onclick="sendMessage()">Send</button>
</div>

<div id="chat">
</div>

<script>
    // Thay đổi URL theo WebSocket server của bạn
    const socketUrl = 'ws://localhost:8080/ws?roomId=1&userId=1';
    const socketUrl2 = 'ws://localhost:8080/ws/notification?userId=1';
    let socket;

    function connectWebSocket() {
        // Khởi tạo kết nối WebSocket
        socket = new WebSocket(socketUrl);

        socket2 = new WebSocket(socketUrl2);

        // Khi kết nối được mở
        socket.onopen = function(event) {
            console.log("WebSocket connection opened.");
            appendMessage("Connected to the server.");
        };

        socket2.onopen = function(event) {
            console.log("WebSocket connection noti opened.");
            online_msg = {
                type: "ONLINE_NOTIFICATION",
                id_sender: "1",
                id_receiver: "NOTIFICATION_1",
                content: "online"
            };
            socket2.send(JSON.stringify(online_msg));
            appendMessage("Connected to the noti server.");
        };

        // Khi nhận được tin nhắn từ server
        socket.onmessage = function(event) {
            console.log(event.data);
            const data = JSON.parse(event.data);
            const senderId = data.senderId;
            const message = data.message;
            appendMessage(`${senderId}: ${message}`);
        };

        socket2.onmessage = function(event) {
            const data = JSON.parse(event.data);
            const senderId = data.sender_id;
            const message = data.content;
            appendMessage(`noti ${senderId}: ${message}`);
        };

        // Khi kết nối bị đóng
        socket.onclose = function(event) {
            console.log("WebSocket connection closed.");
            appendMessage("Disconnected from the server.");
        };

        socket2.onclose = function(event) {
            console.log("WebSocket connection noti closed.");
            online_msg = {
                type: "ONLINE_NOTIFICATION",
                id_sender: "1",
                id_receiver: "NOTIFICATION_1",
                content: "offline"
            };
            socket2.send(JSON.stringify(online_msg));
            appendMessage("Disconnected from the noti server.");
        };

        // Khi có lỗi xảy ra
        socket.onerror = function(error) {
            console.error("WebSocket error:", error);
        };

        socket2.onerror = function(error) {
            console.error("WebSocket error:", error);
        };
    }

    // Gửi tin nhắn tới server
    function sendMessage() {
        const messageInput = document.getElementById("message");
        const message = messageInput.value;

        if (socket && socket.readyState === WebSocket.OPEN) {
            // Gửi tin nhắn dưới dạng JSON
            const data = {
                id: Date.now().toString(),
                id_sender: 1,
                username: 'user1',
                id_receiver: 1,
                content: message,
            };
            socket.send(JSON.stringify(data));
            appendMessage(`You: ${message}`);
            messageInput.value = ""; // Xóa nội dung sau khi gửi
        } else {
            console.log("WebSocket is not open.");
        }

        if (socket2 && socket2.readyState === WebSocket.OPEN) {
            // Gửi tin nhắn dưới dạng JSON
            const data = {
                type: "message",
                id_sender: "1",
                id_receiver: "NOTIFICATION_1",
                content: message
            };
            socket2.send(JSON.stringify(data));
            appendMessage(`You: ${message}`);
            messageInput.value = ""; // Xóa nội dung sau khi gửi
        } else {
            console.log("WebSocket is not open.");
        }
    }

    // Hiển thị tin nhắn lên giao diện
    function appendMessage(text) {
        const chatDiv = document.getElementById("chat");
        const messageParagraph = document.createElement("p");
        messageParagraph.textContent = text;
        chatDiv.appendChild(messageParagraph);
    }

    // Khởi tạo kết nối WebSocket khi tải trang
    connectWebSocket();
</script>
</body>
</html>
